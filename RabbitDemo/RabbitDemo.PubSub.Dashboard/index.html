<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Rabbit Demo Dashboard</title>

    <!-- Bootstrap -->
    <link href="/Content/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">

    <div class="jumbotron">
        <h1>Orders</h1>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div id="orderGauge" style="height: 300px"></div>
        </div>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/Scripts/jquery-2.1.3.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/Scripts/bootstrap.min.js"></script>
<!-- Include SignalR -->
<script src="/Scripts/jquery.signalR-2.2.0.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="signalr/hubs"></script>

<!-- Include JustGage -->
<script src="Scripts/justgage.1.0.1.min.js"></script>
<script src="Scripts/raphael.2.1.0.min.js"></script>

<script type="text/javascript">

    $(function () {

        var orders = [];
        var orderGauge =  new JustGage({
            id: "orderGauge",
            value: 0,
            min: 0,
            max: 1000,
            title: "Order amount per second",
            levelColors: [
              "#ff0000",
              "#ffff00",
              "#00ff00"
            ],
            relativeGaugeSize: true
        });

        // This is called once every 500ms + whenever a new order has been placed
        var refresh = function() {
            var now = Date.now();
            // Only keep a 10 second window of orders
            orders = $.grep(orders, function(o) { return o.timestamp > now - 10000 });

            // Get the total sum of orders the past 10 seconds
            var orderAmount = 0;
            for (var orderIdx in orders) {
                orderAmount += orders[orderIdx].amount;
            }
            // Get the number of orders per second
            var amountPerSecond = Math.round(orderAmount / 10);

            // Refresh the gauge
            orderGauge.refresh(amountPerSecond);
        };

        var runRefresh = function() {
            refresh();
            setTimeout(runRefresh, 500);
        }

        // Declare a proxy to reference the hub. 
        var orderInfoHub = $.connection.orderInfoHub;

        // Create a function that the hub can call to broadcast messages.
        orderInfoHub.client.orderPlaced = function (orderId, amount) {
            orders.push({
                timestamp: Date.now(),
                amount: amount
            });
            refresh();
        };

        $.connection.hub.start().done(function () {

        });

        // Start a refresh loop
        runRefresh();
    });
</script>
</body>
</html>